import{_ as Le,r as g,j as Pe,Q as Ae,a as f,C as Ie,D as Re,u,b as a,c as _,e as i,d as r,w as l,t as b,R as De,F as Z,f as ee,S as C,l as k,y as v,G as h,a6 as Be,N as Fe,L as He,H as $e,n as z,E as oe,p as ze,i as Ne,J as Ue}from"./index.d9d30be3.js";import{M as Ee,H as N,m as Oe}from"./index.23422e4c.js";import Qe from"./chatDeepSearchMessagePanel.2d5a7465.js";import Ge from"./tracePanel.9cc96abf.js";import{C as Me,U as Je,a as Ve,A as je}from"./userQuestionSuggestionsPanel.cb0efdab.js";import{g as Ke,p as We,c as qe}from"./roleChat.91ed275b.js";import{h as Xe,o as Ye}from"./chatsse.0657b2ca.js";import{s as Ze}from"./speaking.fcefe2d3.js";/* empty css                                                                          */import{S as eo}from"./snowflake-id.35ef5390.js";const U=x=>(ze("data-v-f774116f"),x=x(),Ne(),x),oo=["element-loading-spinner"],no={class:"smart-container inner-smart-container"},so={class:"robot-chat-windows"},ao={class:"robot-chat-header"},to={class:"chat-header-title"},lo={class:"chat-header-desc"},io=["onMouseover","onMouseleave"],co={class:"header-images"},ro=["src"],uo={key:0,class:"say-message-info"},ho={key:1,class:"say-message-info"},go=["onClick"],po={class:"chat-debugger"},fo={class:"chat-debugger-item"},_o={key:0,class:"chat-debugger-content"},vo=["innerHTML"],yo=["innerHTML"],ko=["innerHTML"],mo=["innerHTML"],bo=["src"],xo={class:"robot-chat-footer chat-container robot-chat-attachement-panel"},So={class:"message-chat-container"},To={class:"message-input-box"},Co={class:"message-input"},wo={class:"message-btn-box"},Lo=U(()=>i("i",{class:"fa-solid fa-feather icon-btn"},null,-1)),Po=U(()=>i("i",{class:"fa-solid fa-file-word icon-btn"},null,-1)),Ao=U(()=>i("div",{class:"aigen-text-warning"}," \u5185\u5BB9\u7531\u7B2C\u4E09\u65B9 AI \u751F\u6210\uFF0C\u65E0\u6CD5\u786E\u4FDD\u771F\u5B9E\u51C6\u786E\uFF0C\u4EC5\u4F9B\u53C2\u8003 ",-1)),Io={__name:"chatPanel",props:{taskItem:{type:Object,default:null}},setup(x){const ne=x,se=new eo,I=g(se.generate()),{proxy:E}=Ue(),R=g(null),ae=g(null),w=g(null),L=g(228),O=g(!1),D=g(null),P=g(null),m=g({roleName:"\u6DF1\u5EA6\u641C\u7D22\u4E1A\u52A1\u89D2\u8272",responsibilities:"\u6DF1\u5EA6\u641C\u7D22\u4E1A\u52A1\u89D2\u8272"}),p=g(""),B=g(null);g(!1);const Q=g(null),G=g(null),d=g([]);g(null);const M=g(null),S=g(!1),A=new Ee({html:!0,linkify:!0,highlight(e,o){if(!!(o&&N.getLanguage(o))){const c=o||"";return V(N.highlight(e,{language:c}).value,c)}return V(N.highlightAuto(e).value,"")}});A.use(Oe,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});function J(){z(()=>{const o=Q.value.scrollHeight;G.value.setScrollTop(o)})}function V(e,o){return`<pre class="code-block-wrapper"><code class="hljs code-block-body ${o}">${e}</code></pre>`}function te(e){!p.value||(T("send"),p.value="")}function j(e){p.value=e,T("send"),p.value=""}function K(e){return A.render(e)}const le=()=>{let e={};m.value.uploadData&&(e=JSON.parse(m.value.uploadData)),w.value.openFileSelector(e)};function W(e){if(e)return A.render(e)}const F=e=>{if(console.log(`--->>> newMessage = ${JSON.stringify(e)}`),e.llmStream===!0){const o=d.value.findIndex(t=>t.businessId===e.businessId);if(o!==-1){d.value[o].reasoningText+=e.reasoningText,d.value[o].chatText+=e.chatText,d.value[o].messageId=e.messageId,e.usage&&(d.value[o].usage=e.usage),d.value[o].deepSearchFlow=e.deepSearchFlow,ie(e.deepSearchFlow);const t=d.value[o];if(e.flowStep){const c=t.flowStepArr.findIndex(y=>y.stepId===e.flowStep.stepId);console.log("existingStepIdIndex = "+c),c!==-1?(d.value[o].flowStepArr[c].status=e.flowStep.status,d.value[o].flowStepArr[c].isPrint=e.flowStep.print,d.value[o].flowStepArr[c].flowChatText+=e.flowStep.flowChatText,d.value[o].flowStepArr[c].flowReasoningText+=e.flowStep.flowReasoningText,console.log("flow chat text = "+d.value[o].flowStepArr[c].flowChatText)):d.value[o].flowStepArr.push(e.flowStep)}}else e.flowStep&&e.flowStepArr.push(e.flowStep),d.value.push(e)}else d.value.push(e);J()},ie=e=>{R.value.pushDeepsearchFlowTracePanel(e)};function ce(e){const o=" #"+e.messageId+" ";B.value=e.messageId,p.value+=o,T("function")}const re=(e,o)=>{console.log("handleShowDebuggerContent messageIndex = "+e+" , stepIndex = "+o),d.value[e].flowStepArr[o].isPrint=!d.value[e].flowStepArr[o].isPrint};function de(e){z(()=>{if(e){let o=Ye(e);o.onmessage=function(t){if(t.data.includes("[DONE]"))t.data.includes("[DONE]")&&(console.log("\u6D88\u606F\u63A5\u6536\u7ED3\u675F."),S.value=!1);else{let c=t.data;if(c!="ping"){const y=JSON.parse(c);F(y)}}}}})}function ue(e){const o=" #"+e.messageId+" ";B.value=e.messageId,p.value+=o}function he(e){const o={id:e.fileId,name:e.fileName,extension:e.fileType};w.value.setReferenceFile(o)}function ge(e){Ke(e).then(o=>{let t=o.role,c=o.message;m.value=t,F(c),O.value=!1,z(()=>{R.value.setRoleInfo(t)})})}const pe=e=>{console.log("heightVal = "+e),e>0?L.value=e-42:L.value=260-42,console.log("heightDiff.value = "+L.value)},fe=e=>{if(!m.value.voicePlayStatus){oe.error("\u672A\u5F00\u542F\u8BED\u97F3\u64AD\u653E");return}e.getSpeechLoading=!0,We(e).then(o=>{const t=new Blob([o],{type:"audio/wav"}),c=URL.createObjectURL(t),y=new Audio(c);y.addEventListener("ended",()=>{console.log("\u97F3\u9891\u64AD\u653E\u5B8C\u6210"),e.isPlaySpeaking=!1}),e.getSpeechLoading=!1,e.isPlaySpeaking=!0,y.play()}).catch(o=>{e.getSpeechLoading=!1,oe.error("\u64AD\u653E\u5931\u8D25\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u914D\u7F6E\u8BED\u97F3\u670D\u52A1")})},T=e=>{const o=w.value.handleGetUploadFiles();if(console.log("handleGetUploadFiles = "+o),!p.value){E.$modal.msgError("\u8BF7\u8F93\u5165\u6D88\u606F\u5185\u5BB9.");return}S.value=!0;let t={channelId:P.value,channelStreamId:I.value,message:p.value,businessIds:[B.value],type:e,fileIds:o};qe(t,D.value).then(c=>{E.$modal.msgSuccess("\u53D1\u9001\u6210\u529F"),F(c.data)}).catch(c=>{M.value.close()}),p.value=""},_e=async e=>{try{S.value=!0,p.value=e,M.value.close(),T("send")}catch(o){console.error("\u8BED\u97F3\u8BC6\u522B\u8BF7\u6C42\u5931\u8D25:",o),S.value=!1}};function ve(e){d.value.forEach(o=>{o.showTools=o===e})}function ye(e){e.showTools=!1}return Pe(()=>ne.taskItem,(e,o)=>{e&&(console.log("Task item changed:",e),d.value=[],D.value=e.roleId,P.value=e.id,de(I.value),ge(D.value))},{deep:!0,immediate:!0}),Ae(()=>{Xe(I.value).then(e=>{console.log("\u5173\u95EDsse\u8FDE\u63A5\u6210\u529F:"+P)})}),(e,o)=>{const t=f("el-button"),c=f("Loading"),y=f("el-icon"),ke=f("CircleCheck"),me=f("ArrowRightBold"),be=f("ArrowDownBold"),q=f("el-collapse-transition"),xe=f("el-scrollbar"),Se=f("el-input"),Te=f("svg-icon"),H=f("el-tooltip"),X=f("el-col"),Ce=f("el-row"),we=Ie("loading");return Re((a(),_("div",{class:"acp-dashboard aip-chat-dashboard-panel","element-loading-text":"Loading...","element-loading-spinner":e.svg,"element-loading-svg-view-box":"-10, -10, 50, 50",style:{padding:"0px !important"}},[i("div",no,[r(Ce,null,{default:l(()=>[r(X,{span:14},{default:l(()=>[i("div",so,[i("div",ao,[i("div",to,b(x.taskItem.name)+" ",1),i("div",lo,b(x.taskItem.log),1)]),i("div",{class:"robot-chat-body inner-robot-chat-body",style:De("height:calc(100vh - "+u(L)+"px)")},[r(xe,{class:"scroll-panel",ref_key:"scrollbarRef",ref:G,loading:"",always:"","wrap-style":"padding:10px"},{default:l(()=>[i("div",{ref_key:"innerRef",ref:Q},[(a(!0),_(Z,null,ee(u(d),(n,$)=>(a(),_("div",{class:"robot-chat-ai-say-box",onMouseover:s=>ve(n),onMouseleave:s=>ye(n),key:$},[i("div",{class:C(["chat-ai-header",n.roleType=="person"?"say-right-window":""])},[i("div",co,[i("img",{src:e.imagePath(n)},null,8,ro)])],2),i("div",{class:C(["chat-ai-say-body",n.roleType=="person"?"say-right-window":""]),style:{"max-width":"calc(100% - 135px)"}},[n.roleType=="person"?(a(),_("div",uo,[i("span",{style:{"margin-left":"10px"},class:C(n.showTools?"show-tools":"hide-tools")},b(n.dateTime),3),k(" "+b(n.name),1)])):(a(),_("div",ho,[k(b(n.name)+" ",1),n.loading?(a(),v(t,{key:0,size:"default",type:"primary",loading:"",text:""},{default:l(()=>[k("\u4EFB\u52A1\u5904\u7406\u4E2D")]),_:1})):h("",!0),n.reasoningText&&!n.chatText?(a(),v(t,{key:1,size:"default",type:"primary",loading:"",text:""},{default:l(()=>[k("\u63A8\u7406\u4E2D")]),_:1})):h("",!0),i("span",{style:{"margin-left":"10px"},class:C(n.showTools?"show-tools":"hide-tools")},b(n.dateTime),3)])),r(u(Me),{message:n,onHandleFileIdToMessageBox:he},null,8,["message"]),(a(!0),_(Z,null,ee(n.flowStepArr,(s,Y)=>(a(),_("div",{class:"chat-debugger-box",onClick:Ro=>re($,Y),key:Y},[i("div",po,[i("div",fo,[(s==null?void 0:s.status)==="start"?(a(),v(y,{key:0,class:"is-loading"},{default:l(()=>[r(c)]),_:1})):h("",!0),(s==null?void 0:s.status)==="process"?(a(),v(y,{key:1,class:"is-loading"},{default:l(()=>[r(c)]),_:1})):h("",!0),(s==null?void 0:s.status)==="finish"?(a(),v(y,{key:2},{default:l(()=>[r(ke)]),_:1})):h("",!0),k(" "+b(s.message)+" ",1),r(q,null,{default:l(()=>[!s.isPrint&&(s==null?void 0:s.flowChatText)?(a(),v(y,{key:0},{default:l(()=>[r(me)]),_:1})):h("",!0),s.isPrint?(a(),v(y,{key:1},{default:l(()=>[r(be)]),_:1})):h("",!0)]),_:2},1024)]),r(q,null,{default:l(()=>[s.isPrint?(a(),_("div",_o,[s.flowReasoningText?(a(),_("div",{key:0,class:"say-message-body markdown-body chat-reasoning",innerHTML:W(s.flowReasoningText)},null,8,vo)):h("",!0),s.flowChatText?(a(),_("div",{key:1,class:"say-message-body markdown-body",innerHTML:K(s.flowChatText)},null,8,yo)):h("",!0)])):h("",!0)]),_:2},1024)])],8,go))),128)),n.deepSearchFlow?(a(),v(Qe,{key:2,mdi:u(A),deepSearchFlow:n.deepSearchFlow},null,8,["mdi","deepSearchFlow"])):h("",!0),n.reasoningText?(a(),_("div",{key:3,class:"say-message-body markdown-body chat-reasoning",innerHTML:W(n.reasoningText)},null,8,ko)):h("",!0),n.chatText?(a(),_("div",{key:4,class:"say-message-body markdown-body",innerHTML:K(n.chatText)},null,8,mo)):h("",!0),i("div",{class:C(["chat-ai-say-tools",n.roleType=="agent"&&n.chatText&&(n.showTools||n.isPlaySpeaking||n.getSpeechLoading)?"show-tools":"hide-tools"])},[n.isPlaySpeaking?(a(),_("img",{key:0,src:u(Ze),style:{width:"25px","margin-right":"10px",cursor:"pointer"}},null,8,bo)):h("",!0),!n.isPlaySpeaking&&u(m).voicePlayStatus?(a(),v(t,{key:1,type:"info",link:"",icon:"Headset",size:"small",onClick:s=>fe(n),loading:n.getSpeechLoading},{default:l(()=>[k("\u64AD\u653E")]),_:2},1032,["onClick","loading"])):h("",!0),r(t,{type:"info",link:"",icon:"Position",size:"small",onClick:s=>ue(n)},{default:l(()=>[k("\u5F15\u7528")]),_:2},1032,["onClick"]),r(t,{type:"info",link:"",icon:"CopyDocument",size:"small",onClick:s=>u(Be)(n)},{default:l(()=>[k("\u590D\u5236")]),_:2},1032,["onClick"]),n.messageId&&n.roleId&&u(m).functionCallbackScript?(a(),v(t,{key:2,type:"info",size:"small",link:"",icon:"Promotion",onClick:s=>ce(n)},{default:l(()=>[k("\u6267\u884C")]),_:2},1032,["onClick"])):h("",!0)],2),n.roleType=="agent"&&$==u(d).length-1?(a(),v(u(Je),{key:5,ref_for:!0,ref_key:"userQuestionSuggestionsRef",ref:ae,onHandleUserQuestionSuggestionsClick:j,onInitChatBoxScroll:J,roleId:n.roleId,channelId:u(P),greetingQuestion:n.greetingQuestion,chatStreamLoading:u(S)},null,8,["roleId","channelId","greetingQuestion","chatStreamLoading"])):h("",!0)],2)],40,io))),128))],512)]),_:1},512)],4),i("div",xo,[r(u(Ve),{onUpdateChatWindowHeight:pe,onSendAttachmentActions:j,ref_key:"attachmentPanelRef",ref:w},null,512),i("div",So,[i("div",To,[i("div",Co,[r(Se,{class:"input-chat-box",onKeydown:Fe(He(te,["ctrl","prevent"]),["enter"]),modelValue:u(p),"onUpdate:modelValue":o[0]||(o[0]=n=>$e(p)?p.value=n:null),options:e.mentionOptions,prefix:["@"],placeholder:"\u8BF7\u8F93\u5165\u4F60\u7684\u95EE\u9898.",onSelect:e.handleSelect},{label:l(({item:n})=>[k(b(n.label),1)]),_:1},8,["onKeydown","modelValue","options","onSelect"])])]),i("div",wo,[u(m).voiceInputStatus?(a(),v(u(je),{key:0,onSendAudioToBackend:_e,role:u(m)},null,8,["role"])):h("",!0),r(H,{class:"box-item",effect:"dark",content:"\u786E\u8BA4\u53D1\u9001\u6307\u4EE4\u7ED9Agent\uFF0C\u5FEB\u6377\u952E\uFF1AEnter+Ctrl",placement:"top"},{default:l(()=>[r(t,{type:"danger",loading:u(S),text:"",bg:"",size:"large",onClick:o[1]||(o[1]=n=>T("send"))},{default:l(()=>[r(Te,{"icon-class":"send",class:"icon-btn",style:{"font-size":"25px"}})]),_:1},8,["loading"])]),_:1}),r(H,{class:"box-item",effect:"dark",content:"\u6267\u884C\u4EFB\u52A1",placement:"top"},{default:l(()=>[r(t,{type:"warning",text:"",bg:"",size:"large",onClick:o[2]||(o[2]=n=>T("function"))},{default:l(()=>[Lo]),_:1})]),_:1}),u(m).uploadStatus?(a(),v(H,{key:1,class:"box-item",effect:"dark",content:"\u4E0A\u4F20\u6587\u6863\u6587\u4EF6",placement:"top"},{default:l(()=>[r(t,{type:"primary",text:"",bg:"",size:"large",onClick:le},{default:l(()=>[Po]),_:1})]),_:1})):h("",!0)])])]),Ao])]),_:1}),r(X,{span:10},{default:l(()=>[r(Ge,{ref_key:"agentSingleRightPanelRef",ref:R},null,512)]),_:1})]),_:1})])],8,oo)),[[we,u(O)]])}}},Qo=Le(Io,[["__scopeId","data-v-f774116f"]]);export{Qo as default};
