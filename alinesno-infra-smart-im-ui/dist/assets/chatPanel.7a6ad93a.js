import{_ as Re,g as Be,r as s,o as He,K as De,Q as $e,a as p,C as ze,D as Ee,u as h,b as a,c as _,e as c,d as u,w as i,R as Fe,F as W,f as X,S,t as C,l as k,y as v,G as g,N as Ne,L as Ue,H as Ve,n as Y,I as Me,E as R,p as Qe,i as Ge,J as Ke}from"./index.d9d30be3.js";import{M as Oe,H as F,m as je}from"./index.23422e4c.js";import{s as Je}from"./speaking.fcefe2d3.js";import{C as qe,U as We,A as Xe}from"./userQuestionSuggestionsPanel.cb0efdab.js";import{p as Ye,c as Ze,g as eo}from"./roleChat.91ed275b.js";import{h as oo,o as no}from"./chatsse.0657b2ca.js";const Z=w=>(Qe("data-v-ecf8449d"),w=w(),Ge(),w),so=["element-loading-spinner"],to={class:"smart-container inner-smart-container"},ao={class:"robot-chat-windows"},lo=["onMouseover","onMouseleave"],io={class:"header-images"},ro=["src"],co={key:0,class:"say-message-info"},uo={key:1,class:"say-message-info"},go=["onClick"],ho={class:"chat-debugger"},fo={class:"chat-debugger-item"},po={key:0,class:"chat-debugger-content"},_o=["innerHTML"],vo=["innerHTML"],yo=["innerHTML"],ko=["innerHTML"],xo=["src"],bo={class:"robot-chat-footer chat-container",style:{float:"left",width:"100%","margin-top":"40px"}},mo={class:"message-chat-container"},Co={class:"message-input-box"},To={class:"message-input"},So={class:"message-btn-box"},wo={style:{display:"flex","align-items":"center","justify-content":"flex-end"}},Lo=Z(()=>c("i",{class:"fa-solid fa-feather icon-btn"},null,-1)),Io=Z(()=>c("i",{class:"fa-solid fa-file-word icon-btn"},null,-1)),Ao={__name:"chatPanel",setup(w,{expose:ee}){const oe=Be(),L=s(oe.query.channelStreamId);s(!0),s(!1),s(!1),s(!1),s(!1);const ne=s(null),N=s(null),se=s(!1);s(null),s([]),s(""),s("");const te=s(280),{proxy:U}=Ke(),B=s(!0),T=s(null),I=s(null),x=s({}),f=s(""),A=s(null),V=s(null),M=s(null),d=s([]),ae=s([]),H=s(null),Q=s(50),b=s(!1),D=new Oe({html:!0,linkify:!0,highlight(e,o){if(!!(o&&F.getLanguage(o))){const r=o||"";return G(F.highlight(e,{language:r}).value,r)}return G(F.highlightAuto(e).value,"")}});D.use(je,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});function P(){Y(()=>{const o=V.value.scrollHeight;M.value.setScrollTop(o)})}function G(e,o){return`<pre class="code-block-wrapper"><code class="hljs code-block-body ${o}">${e}</code></pre>`}function le(e){!f.value||(m("send"),f.value="")}function ie(e){f.value=e,m("send"),f.value=""}const re=(e,o)=>{console.log("handleShowDebuggerContent messageIndex = "+e+" , stepIndex = "+o),d.value[e].flowStepArr[o].isPrint=!d.value[e].flowStepArr[o].isPrint},ce=async e=>{try{H.value=Me.service({lock:!0,text:"\u8BED\u97F3\u8BC6\u522B\u4E2D...",background:"rgba(0, 0, 0, 0.2)"}),f.value=e,H.value.close(),m("send")}catch(o){console.error("\u8BED\u97F3\u8BC6\u522B\u8BF7\u6C42\u5931\u8D25:",o),H.value.close()}},de=()=>{N.value.openFileSelector(x.value.uploadData)},ue=e=>{if(!x.value.voicePlayStatus){R.error("\u672A\u5F00\u542F\u8BED\u97F3\u64AD\u653E");return}e.getSpeechLoading=!0,Ye(e).then(o=>{const l=new Blob([o],{type:"audio/wav"}),r=URL.createObjectURL(l),y=new Audio(r);y.addEventListener("ended",()=>{console.log("\u97F3\u9891\u64AD\u653E\u5B8C\u6210"),e.isPlaySpeaking=!1}),e.getSpeechLoading=!1,e.isPlaySpeaking=!0,y.play()}).catch(o=>{e.getSpeechLoading=!1,R.error("\u64AD\u653E\u5931\u8D25\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u914D\u7F6E\u8BED\u97F3\u670D\u52A1")})};function K(e){if(e)return D.render(e)}function O(e){if(e)return D.render(e)}const ge=async e=>{try{const o=e.chatText;await navigator.clipboard.writeText(o),R.success("\u590D\u5236\u6210\u529F\uFF01")}catch(o){console.error("\u590D\u5236\u5931\u8D25:",o),R.error("\u590D\u5236\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5\u3002")}},$=e=>{if(d.value.length>=Q.value&&d.value.splice(0,1),e.llmStream===!0){const o=d.value.findIndex(l=>l.businessId===e.businessId);if(o!==-1){d.value[o].reasoningText+=e.reasoningText,d.value[o].chatText+=e.chatText,d.value[o].messageId=e.messageId,e.usage&&(d.value[o].usage=e.usage),d.value[o].fileAttributeList=e.fileAttributeList;const l=d.value[o];if(e.flowStep){const r=l.flowStepArr.findIndex(y=>y.stepId===e.flowStep.stepId);console.log("existingStepIdIndex = "+r),r!==-1?(d.value[o].flowStepArr[r].status=e.flowStep.status,d.value[o].flowStepArr[r].isPrint=e.flowStep.print,d.value[o].flowStepArr[r].flowChatText+=e.flowStep.flowChatText,d.value[o].flowStepArr[r].flowReasoningText+=e.flowStep.flowReasoningText):d.value[o].flowStepArr.push(e.flowStep)}}else e.flowStep&&e.flowStepArr.push(e.flowStep),d.value.push(e)}else d.value.push(e);P()};function he(e){const o=" #"+e.messageId+" ";A.value=e.messageId,f.value+=o,m("function")}function fe(e){Y(()=>{if(e){let o=no(e);o.onmessage=function(l){if(l.data.includes("[DONE]"))l.data.includes("[DONE]")&&(console.log("\u6D88\u606F\u63A5\u6536\u7ED3\u675F."),b.value=!1);else{let r=l.data;if(r!="ping"){const y=JSON.parse(r);$(y)}}}}})}function pe(e){const o=" #"+e.messageId+" ";A.value=e.messageId,f.value+=o}function _e(e){const o={id:e.fileId,name:e.fileName,extension:e.fileType};N.value.setReferenceFile(o)}function j(e){eo(e).then(o=>{let l=o.role,r=o.message;x.value=l,$(r),B.value=!1}).catch(o=>{B.value=!1})}const m=e=>{const o=[];if(!f.value){U.$modal.msgError("\u8BF7\u8F93\u5165\u6D88\u606F\u5185\u5BB9.");return}b.value=!0;let l={channelId:I.value,channelStreamId:L.value,message:f.value,businessIds:[A.value],type:e,fileIds:o};Ze(l,T.value).then(r=>{U.$modal.msgSuccess("\u53D1\u9001\u6210\u529F"),$(r.data)}).catch(r=>{b.value=!1}),f.value="",A.value="",ae.value=[]};function ve(e){d.value.forEach(o=>{o.showTools=o===e})}function ye(e){e.showTools=!1}function ke(e){console.log("roleInfo = "+e.voicePlayStatus),x.value=e}function xe(e,o){P(),b.value=!0,Q.value=3,T.value=e,j(T.value)}function be(e){P(),T.value=e,j(T.value)}return He(()=>{I.value=De("sceneId"),fe(L.value)}),$e(()=>{oo(L.value).then(e=>{console.log("\u5173\u95EDsse\u8FDE\u63A5\u6210\u529F:"+I)})}),ee({setRoleInfo:ke,getChannelStreamId:()=>L.value,openChatBox:xe,openChatBoxWithRole:be}),(e,o)=>{const l=p("el-button"),r=p("Loading"),y=p("el-icon"),me=p("CircleCheck"),Ce=p("ArrowRightBold"),Te=p("ArrowDownBold"),J=p("el-collapse-transition"),Se=p("el-scrollbar"),we=p("el-input"),Le=p("svg-icon"),z=p("el-tooltip"),Ie=p("el-col"),Ae=p("el-row"),Pe=ze("loading");return Ee((a(),_("div",{class:"acp-dashboard aip-chat-dashboard-panel","element-loading-text":"Loading...","element-loading-spinner":e.svg,"element-loading-svg-view-box":"-10, -10, 50, 50",style:{padding:"0px !important"}},[c("div",to,[u(Ae,null,{default:i(()=>[u(Ie,{span:24},{default:i(()=>[c("div",ao,[c("div",{class:"robot-chat-body inner-robot-chat-body",style:Fe("height:calc(100vh - "+h(te)+"px)")},[u(Se,{class:"scroll-panel",ref_key:"scrollbarRef",ref:M,loading:"",always:"","wrap-style":"padding:10px"},{default:i(()=>[c("div",{ref_key:"innerRef",ref:V},[(a(!0),_(W,null,X(h(d),(n,E)=>(a(),_("div",{class:"robot-chat-ai-say-box",onMouseover:t=>ve(n),onMouseleave:t=>ye(n),key:E},[c("div",{class:S(["chat-ai-header",n.roleType=="person"?"say-right-window":""])},[c("div",io,[c("img",{src:e.imagePathByPath(n.icon)},null,8,ro)])],2),c("div",{class:S(["chat-ai-say-body",n.roleType=="person"?"say-right-window":""]),style:{"max-width":"calc(100% - 135px)"}},[n.roleType=="person"?(a(),_("div",co,[c("span",{style:{"margin-left":"10px"},class:S(n.showTools?"show-tools":"hide-tools")},C(n.dateTime),3),k(" "+C(n.name),1)])):(a(),_("div",uo,[k(C(n.name)+" ",1),n.loading?(a(),v(l,{key:0,size:"default",type:"primary",loading:"",text:""},{default:i(()=>[k("\u4EFB\u52A1\u5904\u7406\u4E2D")]),_:1})):g("",!0),n.reasoningText&&!n.chatText?(a(),v(l,{key:1,size:"default",type:"primary",loading:"",text:""},{default:i(()=>[k("\u63A8\u7406\u4E2D")]),_:1})):g("",!0),c("span",{style:{"margin-left":"10px"},class:S(n.showTools?"show-tools":"hide-tools")},C(n.dateTime),3)])),u(h(qe),{message:n,onHandleFileIdToMessageBox:_e},null,8,["message"]),(a(!0),_(W,null,X(n.flowStepArr,(t,q)=>(a(),_("div",{class:"chat-debugger-box",onClick:Ro=>re(E,q),key:q},[c("div",ho,[c("div",fo,[(t==null?void 0:t.status)==="start"?(a(),v(y,{key:0,class:"is-loading"},{default:i(()=>[u(r)]),_:1})):g("",!0),(t==null?void 0:t.status)==="process"?(a(),v(y,{key:1,class:"is-loading"},{default:i(()=>[u(r)]),_:1})):g("",!0),(t==null?void 0:t.status)==="finish"?(a(),v(y,{key:2},{default:i(()=>[u(me)]),_:1})):g("",!0),k(" "+C(t.message)+" ",1),u(J,null,{default:i(()=>[!t.isPrint&&(t==null?void 0:t.flowChatText)?(a(),v(y,{key:0},{default:i(()=>[u(Ce)]),_:1})):g("",!0),t.isPrint?(a(),v(y,{key:1},{default:i(()=>[u(Te)]),_:1})):g("",!0)]),_:2},1024)]),u(J,null,{default:i(()=>[t.isPrint?(a(),_("div",po,[t.flowReasoningText?(a(),_("div",{key:0,class:"say-message-body markdown-body chat-reasoning",innerHTML:O(t.flowReasoningText)},null,8,_o)):g("",!0),t.flowChatText?(a(),_("div",{key:1,class:"say-message-body markdown-body",innerHTML:K(t.flowChatText)},null,8,vo)):g("",!0)])):g("",!0)]),_:2},1024)])],8,go))),128)),n.reasoningText?(a(),_("div",{key:2,class:"say-message-body markdown-body chat-reasoning",innerHTML:O(n.reasoningText)},null,8,yo)):g("",!0),n.chatText?(a(),_("div",{key:3,class:"say-message-body markdown-body",innerHTML:K(n.chatText)},null,8,ko)):g("",!0),c("div",{class:S(["chat-ai-say-tools",n.roleType=="agent"&&n.chatText&&(n.showTools||n.isPlaySpeaking||n.getSpeechLoading)?"show-tools":"hide-tools"])},[c("div",null,[n.isPlaySpeaking?(a(),_("img",{key:0,src:h(Je),style:{width:"25px","margin-right":"10px",cursor:"pointer"}},null,8,xo)):g("",!0),!n.isPlaySpeaking&&h(x).voicePlayStatus?(a(),v(l,{key:1,type:"info",link:"",icon:"Headset",size:"small",onClick:t=>ue(n),loading:n.getSpeechLoading},{default:i(()=>[k("\u64AD\u653E")]),_:2},1032,["onClick","loading"])):g("",!0),n.messageId?(a(),v(l,{key:2,type:"info",link:"",icon:"Position",size:"small",onClick:t=>pe(n)},{default:i(()=>[k("\u5F15\u7528")]),_:2},1032,["onClick"])):g("",!0),u(l,{type:"info",link:"",icon:"CopyDocument",size:"small",onClick:t=>ge(n)},{default:i(()=>[k("\u590D\u5236")]),_:2},1032,["onClick"]),n.messageId&&n.roleId&&h(x).functionCallbackScript?(a(),v(l,{key:3,type:"info",size:"small",link:"",icon:"Promotion",onClick:t=>he(n)},{default:i(()=>[k("\u6267\u884C")]),_:2},1032,["onClick"])):g("",!0)])],2),n.roleType=="agent"&&E==h(d).length-1?(a(),v(h(We),{key:4,ref_for:!0,ref_key:"userQuestionSuggestionsRef",ref:ne,onHandleUserQuestionSuggestionsClick:ie,onInitChatBoxScroll:P,roleId:n.roleId,channelId:h(I),greetingQuestion:n.greetingQuestion,chatStreamLoading:h(b)},null,8,["roleId","channelId","greetingQuestion","chatStreamLoading"])):g("",!0)],2)],40,lo))),128))],512)]),_:1},512)],4),c("div",bo,[c("div",mo,[c("div",Co,[c("div",To,[u(we,{class:"input-chat-box",onKeydown:Ne(Ue(le,["ctrl","prevent"]),["enter"]),modelValue:h(f),"onUpdate:modelValue":o[0]||(o[0]=n=>Ve(f)?f.value=n:null),options:e.mentionOptions,prefix:["@"],placeholder:h(se)?"\u8BF7\u8BF4\u8BDD\uFF0C\u6211\u5728\u542C":"\u8BF7\u8F93\u5165\u4F60\u7684\u95EE\u9898.",onSelect:e.handleSelect},{label:i(({item:n})=>[k(C(n.label),1)]),_:1},8,["onKeydown","modelValue","options","placeholder","onSelect"])])]),c("div",So,[c("div",wo,[h(x).voiceInputStatus?(a(),v(h(Xe),{key:0,onSendAudioToBackend:ce,role:h(x)},null,8,["role"])):g("",!0),u(z,{class:"box-item",effect:"dark",content:"\u786E\u8BA4\u53D1\u9001\u6307\u4EE4\u7ED9Agent\uFF0C\u5FEB\u6377\u952E\uFF1AEnter+Ctrl",placement:"top"},{default:i(()=>[u(l,{type:"danger",loading:h(b),text:"",bg:"",size:"large",onClick:o[1]||(o[1]=n=>m("send"))},{default:i(()=>[u(Le,{"icon-class":"send",class:"icon-btn",style:{"font-size":"25px"}})]),_:1},8,["loading"])]),_:1}),u(z,{class:"box-item",effect:"dark",content:"\u6267\u884C\u4EFB\u52A1",placement:"top"},{default:i(()=>[u(l,{type:"warning",text:"",bg:"",size:"large",onClick:o[2]||(o[2]=n=>m("function"))},{default:i(()=>[Lo]),_:1})]),_:1}),h(x).uploadStatus?(a(),v(z,{key:1,class:"box-item",effect:"dark",content:"\u4E0A\u4F20\u6587\u6863\u6587\u4EF6",placement:"top"},{default:i(()=>[u(l,{type:"primary",text:"",bg:"",size:"large",onClick:de},{default:i(()=>[Io]),_:1})]),_:1})):g("",!0)])])])])])]),_:1})]),_:1})])],8,so)),[[Pe,h(B)]])}}},Fo=Re(Ao,[["__scopeId","data-v-ecf8449d"]]);export{Fo as default};
